<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuis Kelas X Semester 1</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“š</text></svg>">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        MathJax = {
          tex: { inlineMath: [['\\(', '\\)']] }
        };
    </script>
    
    <style>
        /* --- GAYA VISUAL UTAMA (AMBITIOUS STYLE) --- */
        body {
            font-family: 'Poppins', sans-serif;
            overflow-x: hidden;
            transition: background-color 300ms;
            -webkit-font-smoothing: antialiased;
        }
        
        #bg-canvas {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1; background-color: #87CEEB; transition: background-color 300ms;
        }

        /* KONTAINER UTAMA: EFEK KACA (GLASSMORPHISM) */
        .main-container {
            position: relative; z-index: 10; width: 100%; max-width: 42rem;
            margin-top: 4rem; margin-bottom: 4rem;
            background-color: rgba(255, 255, 255, 0.5); /* Transparan Putih */
            backdrop-filter: blur(10px); /* Blur Belakang */
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: background-color 300ms;
        }

        @media (min-width: 1024px) { .main-container { max-width: 64rem; } }
        @media (min-width: 768px) {
            body { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
            .main-container { margin-top: 0; margin-bottom: 0; }
        }
        
        /* Transisi Halaman Halus */
        #menu-container, #quiz-container, #score-container {
            transition: opacity 350ms ease-in-out, transform 350ms ease-in-out;
            width: 100%;
        }
        
        /* Helper Class untuk Logika Tampilan */
        .screen-hidden { 
            display: none !important; 
        }
        .screen-visible { 
            display: block !important; 
            opacity: 1; 
            transform: scale(1) translateY(0); 
        }
        
        /* Animasi Masuk/Keluar */
        .fade-out-up {
            opacity: 0; transform: scale(0.98) translateY(-20px); pointer-events: none;
        }
        .fade-in-up-start {
            opacity: 0; transform: scale(0.98) translateY(20px);
        }
        
        /* Animasi Muncul Bertahap (Staggered) */
        @keyframes reveal {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .reveal-item { opacity: 0; animation: reveal 400ms ease-out forwards; }

        /* Dark Mode Colors */
        body.dark { color: #f3f4f6; }
        body.dark #bg-canvas { background-color: #396991; }
        body.dark .main-container, body.dark .modal-container {
            background-color: rgba(31, 41, 55, 0.5); /* Transparan Gelap */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        body.dark h1, body.dark h2, body.dark h3, body.dark h4, body.dark p, body.dark strong, body.dark #question-text, body.dark #modal-nav-title { color: #f3f4f6; }
        body.dark .text-slate-700, body.dark .text-slate-900 { color: #e5e7eb !important; }
        
        /* Tombol Interaktif (Efek Tekan & Bayangan) */
        .interactive-btn {
            transition: all 0.2s ease-out; border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .interactive-btn:hover {
            transform: translateY(-2px); filter: brightness(1.1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
        }
        .interactive-btn:active {
            transform: scale(0.98) translateY(0px); filter: brightness(0.9); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        body.dark .interactive-btn:hover { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }

        /* Warna Gradien Tombol */
        #start-btn, #finish-btn, #confirm-finish-btn { background-image: linear-gradient(to right, #34d399, #10b981); }
        #next-btn, #reset-btn { background-image: linear-gradient(to right, #0ea5e9, #3b82f6); }
        #review-btn { background-image: linear-gradient(to right, #d946ef, #a855f7); }
        #review-back-btn, #cancel-finish-btn { background-image: linear-gradient(to right, #f43f5e, #ef4444); }
        
        #back-to-menu-score-btn { background-color: #e5e7eb; color: #374151; }
        body.dark #back-to-menu-score-btn { background-color: #374151; color: #f3f4f6; }
        
        /* Tombol Pilihan Ganda (Efek Kaca) */
        .option-btn {
            transition: all 0.2s ease-out;
            background-color: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 0.75rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .option-btn:hover {
            transform: scale(1.02); background-color: rgba(255, 255, 255, 0.5); border-color: rgba(255, 255, 255, 0.6);
        }
        body.dark .option-btn {
            background-color: rgba(55, 65, 81, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1); color: #f3f4f6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        body.dark .option-btn:hover {
            transform: scale(1.02); background-color: rgba(55, 65, 81, 0.5); border-color: rgba(255, 255, 255, 0.2);
        }
        
        .selected-answer {
            background-color: #dbeafe !important; border-color: #2563eb !important; color: #1e3a8a !important;
            font-weight: 600; transform: scale(1.02); box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }
        body.dark .selected-answer {
            background-color: #1e3a8a !important; border-color: #60a5fa !important; color: #eff6ff !important;
            box-shadow: 0 4px 15px rgba(96, 165, 250, 0.3);
        }
        .correct-answer { background-color: #dcfce7 !important; border-color: #22c55e !important; color: #166534 !important; transform: scale(1.02); border-width: 2px; }
        body.dark .correct-answer { background-color: #064e3b !important; border-color: #34d399 !important; color: #d1fae5 !important; }
        .wrong-answer { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #991b1b !important; transform: scale(1.02); border-width: 2px; }
        body.dark .wrong-answer { background-color: #7f1d1d !important; border-color: #f87171 !important; color: #fee2e2 !important; }

        /* Tombol Mata Pelajaran (Efek Kaca) */
        .subject-active { background-image: linear-gradient(to right, #0ea5e9, #3b82f6); color: white; font-weight: 500; }
        .subject-inactive {
            background-color: rgba(229, 231, 235, 0.3); backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);
            border: 1px solid rgba(255, 255, 255, 0.4); color: #374151; font-weight: 500;
        }
        body.dark .subject-inactive {
             background-color: rgba(55, 65, 81, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); color: #f3f4f6;
        }
        .subject-inactive:hover { background-color: rgba(229, 231, 235, 0.5); }
        body.dark .subject-inactive:hover { background-color: rgba(55, 65, 81, 0.5); }

        /* Tombol Navigasi Soal */
        .q-nav-btn {
            display: flex; align-items: center; justify-content: center; width: 100%; aspect-ratio: 1/1;
            border-radius: 0.375rem; font-weight: 700; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .q-nav-btn:active { transform: scale(0.95); filter: brightness(0.9); }
        
        .q-nav-unanswered {
            background-color: rgba(226, 232, 240, 0.3); backdrop-filter: blur(3px);
            border: 1px solid rgba(255, 255, 255, 0.4); color: #334155;
        }
        body.dark .q-nav-unanswered {
            background-color: rgba(55, 65, 81, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); color: #f3f4f6;
        }
        .q-nav-unanswered:hover { background-color: rgba(203, 213, 225, 0.5); transform: translateY(-2px); }
        body.dark .q-nav-unanswered:hover { background-color: rgba(55, 65, 81, 0.5); transform: translateY(-2px); }
        
        .q-nav-answered-quiz { background-color: #60a5fa; color: white; }
        .q-nav-answered-quiz:hover { background-color: #3b82f6; transform: translateY(-2px); }
        body.dark .q-nav-answered-quiz { background-color: #2563eb; }
        
        .q-nav-answered { background-color: #22c55e; color: white; }
        .q-nav-wrong-answered { background-color: #ef4444; color: white; }
        .q-nav-active { background-color: #f59e0b; color: #1f2937; outline: 2px solid #f59e0b; outline-offset: 2px; }
        .q-nav-active:hover { transform: translateY(0px); }

        /* Panel Daftar Soal & Scrollbars */
        #quiz-nav-panel, #desktop-nav-panel {
            display: grid; grid-template-columns: repeat(6, minmax(0, 1fr)); gap: 0.5rem; padding: 0.75rem;
            border-radius: 0.5rem; max-height: 16rem; overflow-y: auto; scroll-behavior: smooth;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(107, 114, 128, 0.8); }
        
        body.dark ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        body.dark ::-webkit-scrollbar-thumb { background: rgba(75, 85, 99, 0.8); }
        
        /* Scrollbar Wacana Dark Mode */
        body.dark #passage-container { scrollbar-color: #4b5563 #374151; scrollbar-width: auto; }
        body.dark #passage-container::-webkit-scrollbar { width: 16px; }
        body.dark #passage-container::-webkit-scrollbar-track { background: #374151; border-radius: 10px; }
        body.dark #passage-container::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 10px; border: 4px solid #374151; }

        /* Floating Buttons */
        .floating-icon-btn {
            background-color: rgba(255, 255, 255, 0.5); backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);
            padding: 10px; border-radius: 9999px; border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: all 300ms ease;
            cursor: pointer; position: relative; width: 42px; height: 42px;
        }
        .floating-icon-btn:hover { transform: scale(1.1); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15); }
        .floating-icon-btn:active { transform: scale(0.95); }
        body.dark .floating-icon-btn { background-color: rgba(55, 65, 81, 0.5); border: 1px solid rgba(255, 255, 255, 0.1); color: #f3f4f6; }
        .floating-icon-btn > svg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: opacity 0.3s, transform 0.3s; }

        /* Modal Popups (Glass) */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
            z-index: 40; opacity: 0; transition: opacity 300ms ease-in-out; pointer-events: none;
        }
        .modal-container {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; width: 90%; max-width: 32rem;
            background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 1.5rem;
            opacity: 0; transition: opacity 300ms ease-in-out, transform 300ms ease-in-out; pointer-events: none;
        }
        body.dark .modal-container { background-color: rgba(31, 41, 55, 0.8); }

        .modal-active .modal-backdrop { opacity: 1; pointer-events: auto; }
        .modal-active .modal-container { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }

        #loading-spinner svg { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 min-h-screen flex items-center justify-center">
    
    <canvas id="bg-canvas"></canvas>

    <audio id="bg-music" src="./assets/musikku.mp3" loop muted></audio>

    <div id="floating-controls" style="position: fixed; top: 20px; right: 20px; z-index: 100; display: flex; gap: 10px;">
        <button id="theme-toggle-btn-floating" class="floating-icon-btn">
            <svg id="theme-sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
            <svg id="theme-moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0; transform: translate(-50%, -50%) rotate(-90deg) scale(0.5);"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
        </button>
        <button id="music-toggle-btn-floating" class="floating-icon-btn is-muted" style="background-color: #fee2e2; color: #b91c1c;">
            <svg id="music-icon-unmuted" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0; transform: translate(-50%, -50%) scale(0.5);"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
            <svg id="music-icon-muted" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="22" x2="16" y1="9" y2="15"/><line x1="16" x2="22" y1="9" y2="15"/></svg>
        </button>
    </div>

    <div class="main-container p-4 sm:p-6">
        <!-- MENU -->
        <div id="menu-container" class="screen-visible">
            <h1 class="text-3xl font-bold text-center text-slate-900 mb-6 dark:text-white">Kuis Kelas X Semester 1</h1>
            <h2 class="text-lg font-semibold text-slate-900 mb-3 dark:text-gray-200">Pilih Mata Pelajaran:</h2>
            
            <div id="loading-spinner" class="flex flex-col items-center justify-center my-6">
                <svg class="w-8 h-8 text-blue-600 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">Memuat daftar pelajaran...</p>
            </div>
            
            <div id="subject-button-container" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6 hidden"></div>
            
            <button id="start-btn" class="interactive-btn w-full bg-green-600 text-white px-6 py-4 rounded-lg font-bold text-lg hover:bg-green-700 transition-all hidden">
                Mulai Kuis
            </button>
        </div>
        
        <!-- KUIS -->
        <div id="quiz-container" class="screen-hidden">
            <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                <h1 id="quiz-title" class="text-xl font-bold text-slate-900 dark:text-white">Kuis</h1>
                <div class="flex items-center gap-3">
                    <div id="timer-display" class="text-lg font-semibold text-red-600 bg-red-100 px-3 py-1 rounded-md">80:00</div>
                    <button id="open-nav-btn" class="text-sm text-white bg-blue-600 px-3 py-1 rounded-md hover:bg-blue-700 font-medium lg:hidden interactive-btn">
                        Daftar Soal
                    </button>
                    <button id="back-to-menu-quiz-btn" class="text-sm text-blue-600 hover:underline dark:text-blue-400">
                        Kembali ke Menu
                    </button>
                </div>
            </div>

            <div class="lg:flex lg:gap-6">
                <div id="quiz-content" class="w-full lg:w-7/12">
                    <div id="passage-container" class="mb-5 p-4 border rounded-lg max-h-48 overflow-y-auto hidden bg-white/40 dark:bg-slate-800/40">
                        <h4 id="passage-title" class="font-bold text-sm text-gray-900 mb-2 dark:text-gray-100"></h4>
                        <div id="passage-content" class="text-sm text-gray-900 leading-relaxed dark:text-gray-200"></div>
                    </div>

                    <div id="question-loading-spinner" class="hidden flex-col items-center justify-center my-6">
                         <svg class="w-8 h-8 text-blue-600 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </div>

                    <div id="question-area">
                        <div id="question-counter" class="text-sm font-medium text-slate-600 bg-slate-200 px-3 py-1 rounded-full w-fit mb-4 dark:bg-slate-700 dark:text-slate-300"></div>
                        <div class="mb-5">
                            <p id="question-text" class="text-lg font-semibold text-slate-900 leading-relaxed dark:text-white"></p>
                        </div>
                        <div id="options-container" class="flex flex-col gap-3"></div>
                    </div>

                    <div id="explanation-box" class="hidden mt-4 p-4 rounded-lg border">
                        <p id="explanation-text" class="text-sm mt-1"></p>
                    </div>

                    <div class="flex flex-col sm:flex-row sm:justify-between items-center mt-6 gap-2">
                        <button id="prev-btn" class="interactive-btn bg-slate-300 text-slate-700 px-5 py-2 rounded-lg font-medium hover:bg-slate-400 disabled:opacity-50 w-full sm:w-auto">
                            Sebelumnya
                        </button>
                        <button id="finish-btn" class="interactive-btn bg-green-600 text-white px-5 py-3 sm:py-2 rounded-lg font-bold hover:bg-green-700 w-full sm:w-auto order-first sm:order-none text-lg sm:text-base">
                            Selesai
                        </button>
                         <button id="review-back-btn" class="interactive-btn hidden bg-red-500 text-white px-5 py-3 sm:py-2 rounded-lg font-bold hover:bg-red-600 w-full sm:w-auto order-first sm:order-none text-lg sm:text-base">
                            Kembali ke Menu Skor
                        </button>
                        <button id="next-btn" class="interactive-btn bg-blue-600 text-white px-5 py-2 rounded-lg font-medium hover:bg-blue-700 w-full sm:w-auto">
                            Berikutnya
                        </button>
                    </div>
                </div>

                <div id="desktop-nav-container" class="hidden lg:block lg:w-5/12">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4 dark:text-gray-200">Daftar Soal</h3>
                    <div id="desktop-nav-panel"></div>
                </div>
            </div>
        </div>

        <!-- SKOR -->
        <div id="score-container" class="screen-hidden text-center">
            <h2 class="text-2xl font-bold text-slate-900 mb-4 dark:text-white">Kuis Selesai!</h2>
            <p class="text-xl text-slate-700 mb-2 dark:text-gray-300">Skor Anda:</p>
            <p id="score-text" class="text-5xl font-bold text-blue-600 mb-6"></p>
            
            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                <button id="review-btn" class="interactive-btn bg-purple-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-purple-700 transition-all text-lg">
                    Lihat Pembahasan
                </button>
                <button id="reset-btn" class="interactive-btn bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-all text-lg">
                    Ulangi Kuis
                </button>
                <button id="back-to-menu-score-btn" class="interactive-btn bg-slate-300 text-slate-700 px-6 py-3 rounded-lg font-medium hover:bg-slate-400 transition-all text-lg">
                    Kembali ke Menu
                </button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="modal-nav-wrapper" class="">
        <div id="modal-backdrop-nav" class="modal-backdrop"></div>
        <div id="modal-container-nav" class="modal-container p-4 sm:p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-nav-title" class="text-lg font-semibold text-slate-900 dark:text-white">Daftar Soal</h3>
                <button id="close-nav-btn" class="p-1.5 rounded-md text-red-600 bg-red-100 hover:bg-red-200 dark:bg-red-800 dark:text-red-300 hover:scale-110 transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            <div id="quiz-nav-panel" class="grid grid-cols-6 gap-2 max-h-64 overflow-y-auto"></div>
        </div>
    </div>
    
    <div id="modal-finish-wrapper" class="">
        <div id="modal-backdrop-finish" class="modal-backdrop"></div>
        <div id="modal-container-finish" class="modal-container p-4 sm:p-6">
            <h3 class="text-xl font-bold text-slate-900 mb-4 dark:text-white">Konfirmasi Selesai</h3>
            <p class="text-slate-700 mb-6 dark:text-gray-300">Anda yakin sudah mengerjakan semua soal dan mengeceknya?</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-finish-btn" class="interactive-btn bg-red-500 text-white px-5 py-2 rounded-lg font-medium hover:bg-red-600">
                    Eh, gajadi
                </button>
                <button id="confirm-finish-btn" class="interactive-btn bg-green-600 text-white px-5 py-2 rounded-lg font-medium hover:bg-green-700">
                    Iya, udah nih
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        let allSubjects = []; 
        let quizzesCache = new Map(); 
        let currentQuestionIndex = 0;
        let score = 0;
        let userAnswers = []; 
        let selectedSubjectId = null; 
        let activeQuizData = []; 
        let timerInterval = null; 
        let remainingTime = 80 * 60; 
        let audioInitialized = false;
        let isReviewMode = false; 
        let isUserMuted = true;
        let animationFrameId = null;
        const QUIZ_STATE_KEY = 'savedQuizState';

        const HIGH_VOLUME = 1.0; 
        const LOW_VOLUME = 0.7;

        // DOM Elements
        const menuContainer = document.getElementById('menu-container');
        const quizContainer = document.getElementById('quiz-container');
        const scoreContainer = document.getElementById('score-container');
        const subjectButtonContainer = document.getElementById('subject-button-container'); 
        const startBtn = document.getElementById('start-btn');
        const quizTitle = document.getElementById('quiz-title');
        const questionCounter = document.getElementById('question-counter');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const questionLoadingSpinner = document.getElementById('question-loading-spinner');
        const timerDisplay = document.getElementById('timer-display');
        const passageContainer = document.getElementById('passage-container');
        const passageTitleEl = document.getElementById('passage-title');
        const passageContentEl = document.getElementById('passage-content');
        const explanationBox = document.getElementById('explanation-box');
        const explanationText = document.getElementById('explanation-text');
        
        // Modals
        const navWrapper = document.getElementById('modal-nav-wrapper');
        const finishWrapper = document.getElementById('modal-finish-wrapper');

        // Audio Elements
        const bgMusic = document.getElementById('bg-music');
        const musicBtn = document.getElementById('music-toggle-btn-floating');
        const themeBtn = document.getElementById('theme-toggle-btn-floating');
        const sunIcon = document.getElementById('theme-sun-icon');
        const moonIcon = document.getElementById('theme-moon-icon');
        const unmutedIcon = document.getElementById('music-icon-unmuted');
        const mutedIcon = document.getElementById('music-icon-muted');

        // Tone.js Synths
        const popSfxHigh = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.05, sustain: 0, release: 0.1 } }).toDestination();
        const popSfxMid = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.05, sustain: 0, release: 0.1 } }).toDestination();
        const popSfxLow = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.05, sustain: 0, release: 0.1 } }).toDestination();
        const alarmSfx = new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();

        async function initAudio() {
            if (audioInitialized) return;
            try {
                await Tone.start();
                bgMusic.volume = HIGH_VOLUME;
                audioInitialized = true;
            } catch (e) { console.warn("Audio init failed", e); }
        }

        function updateMusicState(shouldMute) {
            isUserMuted = shouldMute;
            bgMusic.muted = shouldMute;
            musicBtn.style.backgroundColor = shouldMute ? '#fee2e2' : '#dcfce7';
            musicBtn.style.color = shouldMute ? '#b91c1c' : '#166534';
            
            if (shouldMute) {
                unmutedIcon.style.opacity = 0; unmutedIcon.style.transform = 'translate(-50%, -50%) scale(0.5)';
                mutedIcon.style.opacity = 1; mutedIcon.style.transform = 'translate(-50%, -50%) scale(1)';
            } else {
                unmutedIcon.style.opacity = 1; unmutedIcon.style.transform = 'translate(-50%, -50%) scale(1)';
                mutedIcon.style.opacity = 0; mutedIcon.style.transform = 'translate(-50%, -50%) scale(0.5)';
                bgMusic.play().catch(() => {});
            }
        }

        function setMusicVolume(vol) { if (!isUserMuted) bgMusic.volume = vol; }

        // Canvas Animation
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        
        class Particle {
            constructor() { 
                this.reset(); 
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
            }
            reset() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 10 + 5;
                this.speedX = Math.random() * 0.5 - 0.25;
                this.speedY = Math.random() * 0.5 - 0.25;
                this.type = Math.random() > 0.5 ? 'book' : 'pen';
                this.rotation = Math.random() * 360;
                this.color = document.body.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.4)';
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.rotation += 0.2;
                if (this.x < -50 || this.x > canvas.width + 50 || this.y < -50 || this.y > canvas.height + 50) this.reset();
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation * Math.PI / 180);
                ctx.fillStyle = this.color;
                if (this.type === 'book') {
                    ctx.fillRect(-this.size/2, -this.size/1.5/2, this.size, this.size/1.5);
                } else {
                    ctx.fillRect(-this.size/2, -this.size/8/2, this.size, this.size/8);
                }
                ctx.restore();
            }
        }
        
        function initParticles() {
            particles = [];
            for(let i=0; i<30; i++) particles.push(new Particle()); 
        }
        
        function animateCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => { p.update(); p.draw(); });
            animationFrameId = requestAnimationFrame(animateCanvas);
        }

        // Screen Transition
        function switchScreen(fromEl, toEl) {
            fromEl.classList.remove('screen-visible');
            fromEl.classList.add('fade-out-up');
            
            setTimeout(() => {
                fromEl.classList.add('screen-hidden');
                fromEl.classList.remove('fade-out-up');
                
                toEl.classList.remove('screen-hidden');
                toEl.classList.add('fade-in-up-start');
                
                void toEl.offsetWidth; // Force reflow
                
                toEl.classList.remove('fade-in-up-start');
                toEl.classList.add('screen-visible');
            }, 300);
        }

        // Save/Load State
        function saveQuizState() {
            if (isReviewMode || !activeQuizData.length) return;
            localStorage.setItem(QUIZ_STATE_KEY, JSON.stringify({
                subjectId: selectedSubjectId,
                answers: userAnswers,
                index: currentQuestionIndex,
                time: remainingTime
            }));
        }
        
        function clearQuizState() { localStorage.removeItem(QUIZ_STATE_KEY); }

        // FIX: startQuiz logic to prevent blocking
        async function startQuiz(subjectId, savedState = null) {
            isReviewMode = false;
            // FIX: DO NOT await initAudio here, just call it. Browsers block audio context start until interaction.
            initAudio(); 
            
            if (!savedState) switchScreen(menuContainer, quizContainer);
            setMusicVolume(LOW_VOLUME);

            try {
                let flatQuestions = [];
                if (quizzesCache.has(subjectId)) {
                    flatQuestions = quizzesCache.get(subjectId);
                } else {
                    const ts = new Date().getTime();
                    const response = await fetch(`./data/${subjectId}.json?v=${ts}`);
                    if (!response.ok) throw new Error("File not found");
                    const data = await response.json();
                    
                    if (data.length > 0 && data[0].questions) {
                        data.forEach(g => {
                            g.questions.forEach(q => flatQuestions.push({...q, passageTitle: g.passageTitle, passageText: g.passageText}));
                        });
                    } else {
                        flatQuestions = data;
                    }
                    quizzesCache.set(subjectId, flatQuestions);
                }

                activeQuizData = flatQuestions;
                selectedSubjectId = subjectId;
                const subject = allSubjects.find(s => s.id === subjectId);
                if (subject) quizTitle.textContent = subject.title;

                if (savedState) {
                    userAnswers = savedState.answers;
                    currentQuestionIndex = savedState.index;
                    remainingTime = savedState.time;
                } else {
                    currentQuestionIndex = 0;
                    score = 0;
                    userAnswers = new Array(activeQuizData.length).fill(null);
                    remainingTime = 80 * 60;
                }

                generateNavPanels();
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(updateTimer, 1000);
                updateTimer();

                if (!savedState) {
                    questionArea.classList.add('opacity-0');
                    questionLoadingSpinner.classList.remove('hidden');
                }

                // FIX: Ensure this runs after loading
                renderQuestion().then(() => {
                    if (!savedState) {
                        questionLoadingSpinner.classList.add('hidden');
                        questionArea.classList.remove('opacity-0');
                    }
                });

            } catch (e) {
                console.error(e);
                alert("Gagal memuat kuis. Coba refresh.");
                goToMenu();
            }
        }

        async function renderQuestion() {
            explanationBox.classList.add('hidden');
            optionsContainer.innerHTML = '';
            const qData = activeQuizData[currentQuestionIndex];

            if (qData.passageText) {
                passageTitleEl.innerHTML = qData.passageTitle;
                passageContentEl.innerHTML = qData.passageText;
                passageContainer.classList.remove('hidden');
            } else {
                passageContainer.classList.add('hidden');
            }

            questionText.innerHTML = qData.question;
            questionCounter.textContent = `Soal ${currentQuestionIndex + 1} dari ${activeQuizData.length}`;

            qData.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                const letter = String.fromCharCode(65 + idx);
                btn.innerHTML = `${letter}. ${opt}`;
                btn.className = 'option-btn border p-3 text-left w-full focus:outline-none focus:ring-2 focus:ring-blue-500';
                btn.classList.add('reveal-item');
                btn.style.animationDelay = `${idx * 50}ms`;

                if (!isReviewMode) {
                    btn.onclick = () => handleAnswer(idx);
                }
                optionsContainer.appendChild(btn);
            });

            updateNavButtons();
            updateNavState();

            if (isReviewMode) showFeedback(userAnswers[currentQuestionIndex] ?? -1);
            else {
                timerDisplay.classList.remove('hidden');
                const savedAns = userAnswers[currentQuestionIndex];
                if (savedAns !== null && optionsContainer.children[savedAns]) {
                    optionsContainer.children[savedAns].classList.add('selected-answer');
                }
            }

            if (window.MathJax) {
                await MathJax.typesetPromise([passageContainer, questionArea, optionsContainer]);
            }
        }

        function handleAnswer(idx) {
            popSfxMid.triggerAttackRelease('G5', '16n', Tone.now());
            userAnswers[currentQuestionIndex] = idx;
            Array.from(optionsContainer.children).forEach(b => b.classList.remove('selected-answer'));
            optionsContainer.children[idx].classList.add('selected-answer');
            updateNavState();
            saveQuizState();
        }

        function showFeedback(selectedIdx) {
            const correctIdx = activeQuizData[currentQuestionIndex].correctAnswer;
            const btns = optionsContainer.children;
            for(let i=0; i<btns.length; i++) {
                btns[i].disabled = true;
                if (i === correctIdx) btns[i].classList.add('correct-answer');
                else if (i === selectedIdx) btns[i].classList.add('wrong-answer');
            }
            explanationText.innerHTML = `<strong>Penjelasan:</strong> ${activeQuizData[currentQuestionIndex].explanation}`;
            explanationBox.className = `mt-4 p-4 rounded-lg border ${selectedIdx === correctIdx ? 'explanation-correct' : 'explanation-wrong'}`;
            explanationBox.classList.remove('hidden');
            if (window.MathJax) MathJax.typesetPromise([explanationBox]);
        }

        function updateTimer() {
            remainingTime--;
            const m = Math.floor(remainingTime / 60);
            const s = remainingTime % 60;
            timerDisplay.textContent = `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
            if (remainingTime % 5 === 0) saveQuizState();
            if (remainingTime <= 0) {
                clearInterval(timerInterval);
                alarmSfx.triggerAttackRelease('A5', '8n');
                finishQuiz();
            }
        }

        function generateNavPanels() {
            const mobPanel = document.getElementById('quiz-nav-panel');
            const deskPanel = document.getElementById('desktop-nav-panel');
            mobPanel.innerHTML = ''; deskPanel.innerHTML = '';
            activeQuizData.forEach((_, i) => {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'q-nav-btn q-nav-unanswered';
                btn.dataset.index = i;
                const btnDesk = btn.cloneNode(true);
                btn.onclick = () => jumpToQuestion(i, true);
                btnDesk.onclick = () => jumpToQuestion(i, false);
                mobPanel.appendChild(btn);
                deskPanel.appendChild(btnDesk);
            });
        }

        function updateNavState() {
            const btns = document.querySelectorAll('.q-nav-btn');
            btns.forEach(b => {
                const i = parseInt(b.dataset.index);
                b.className = 'q-nav-btn';
                if (i === currentQuestionIndex) b.classList.add('q-nav-active');
                else if (userAnswers[i] !== null) {
                    if (isReviewMode) {
                        const isCorrect = userAnswers[i] === activeQuizData[i].correctAnswer;
                        b.classList.add(isCorrect ? 'q-nav-answered' : 'q-nav-wrong-answered');
                    } else {
                        b.classList.add('q-nav-answered-quiz');
                    }
                } else {
                    b.classList.add('q-nav-unanswered');
                }
            });
        }

        function jumpToQuestion(idx, isModal) {
            popSfxHigh.triggerAttackRelease('C6', '16n', Tone.now());
            saveQuizState();
            currentQuestionIndex = idx;
            renderQuestion();
            if (isModal) toggleModal(navWrapper, false);
        }

        function updateNavButtons() {
            const prev = document.getElementById('prev-btn');
            const next = document.getElementById('next-btn');
            const finish = document.getElementById('finish-btn');
            const reviewBack = document.getElementById('review-back-btn');
            const backMenu = document.getElementById('back-to-menu-quiz-btn');

            prev.disabled = currentQuestionIndex === 0;
            
            if (isReviewMode) {
                finish.classList.add('hidden');
                reviewBack.classList.remove('hidden');
                backMenu.classList.add('hidden'); 
                if (currentQuestionIndex === activeQuizData.length - 1) next.classList.add('hidden');
                else { next.classList.remove('hidden'); next.textContent = 'Berikutnya'; }
            } else {
                finish.classList.remove('hidden');
                reviewBack.classList.add('hidden');
                backMenu.classList.remove('hidden');
                if (currentQuestionIndex === activeQuizData.length - 1) next.classList.add('hidden');
                else { next.classList.remove('hidden'); next.textContent = 'Berikutnya'; }
            }
        }

        function finishQuiz() {
            clearQuizState();
            if (!isReviewMode) {
                score = 0;
                userAnswers.forEach((ans, i) => {
                    if (ans === activeQuizData[i].correctAnswer) score++;
                });
            }
            switchScreen(quizContainer, scoreContainer);
            toggleModal(finishWrapper, false);
            scoreText.textContent = `${score} / ${activeQuizData.length}`;
            isReviewMode = false;
            setMusicVolume(HIGH_VOLUME);
            if (timerInterval) clearInterval(timerInterval);
        }

        function goToMenu() {
            isReviewMode = false;
            clearQuizState();
            setMusicVolume(HIGH_VOLUME);
            if (timerInterval) clearInterval(timerInterval);
            const current = !quizContainer.classList.contains('screen-hidden') ? quizContainer : scoreContainer;
            switchScreen(current, menuContainer);
            
            // FIX: Ensure menu is ready (reset buttons visibility)
            setTimeout(() => {
                loadingSpinner.classList.add('hidden');
                subjectButtonContainer.classList.remove('hidden');
                startBtn.classList.remove('hidden');
                resetSubjectButtonAnimations();
            }, 350);
        }

        function toggleModal(wrapper, show) {
            if (show) wrapper.classList.add('modal-active');
            else wrapper.classList.remove('modal-active');
        }

        // Reset Button Animations Helper
        function resetSubjectButtonAnimations() {
            const items = subjectButtonContainer.querySelectorAll('.reveal-item');
            items.forEach((item, index) => {
                item.style.opacity = 0;
                item.classList.remove('reveal-item');
                void item.offsetWidth;
                item.classList.add('reveal-item');
                item.style.animationDelay = `${index * 50}ms`;
            });
            startBtn.style.opacity = 0;
            startBtn.classList.remove('reveal-item');
            void startBtn.offsetWidth;
            startBtn.classList.add('reveal-item');
            startBtn.style.animationDelay = `${items.length * 50}ms`;
        }

        document.getElementById('prev-btn').onclick = () => { if (currentQuestionIndex > 0) { currentQuestionIndex--; saveQuizState(); renderQuestion(); } };
        document.getElementById('next-btn').onclick = () => { if (currentQuestionIndex < activeQuizData.length - 1) { currentQuestionIndex++; saveQuizState(); renderQuestion(); } };
        document.getElementById('open-nav-btn').onclick = () => toggleModal(navWrapper, true);
        document.getElementById('close-nav-btn').onclick = () => toggleModal(navWrapper, false);
        document.getElementById('modal-backdrop-nav').onclick = () => toggleModal(navWrapper, false);
        document.getElementById('finish-btn').onclick = () => toggleModal(finishWrapper, true);
        document.getElementById('cancel-finish-btn').onclick = () => toggleModal(finishWrapper, false);
        document.getElementById('confirm-finish-btn').onclick = finishQuiz;
        
        document.getElementById('reset-btn').onclick = () => {
            clearQuizState();
            switchScreen(scoreContainer, quizContainer);
            currentQuestionIndex = 0; score = 0;
            userAnswers = new Array(activeQuizData.length).fill(null);
            remainingTime = 80 * 60;
            generateNavPanels();
            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();
            renderQuestion();
            setMusicVolume(LOW_VOLUME);
        };
        
        document.getElementById('review-btn').onclick = () => {
            isReviewMode = true;
            currentQuestionIndex = 0;
            switchScreen(scoreContainer, quizContainer);
            renderQuestion();
            setMusicVolume(LOW_VOLUME);
        };

        const backBtns = [document.getElementById('back-to-menu-quiz-btn'), document.getElementById('back-to-menu-score-btn'), document.getElementById('review-back-btn')];
        backBtns.forEach(b => b.onclick = goToMenu);

        themeBtn.onclick = () => {
            const isDark = document.body.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            sunIcon.style.opacity = isDark ? 0 : 1; sunIcon.style.transform = isDark ? 'translate(-50%, -50%) rotate(90deg) scale(0.5)' : 'translate(-50%, -50%) rotate(0deg) scale(1)';
            moonIcon.style.opacity = isDark ? 1 : 0; moonIcon.style.transform = isDark ? 'translate(-50%, -50%) rotate(0deg) scale(1)' : 'translate(-50%, -50%) rotate(-90deg) scale(0.5)';
            particles.forEach(p => p.color = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.4)');
        };

        musicBtn.onclick = async () => {
            await initAudio();
            updateMusicState(!isUserMuted);
            if (!isUserMuted) {
                const inQuiz = !quizContainer.classList.contains('screen-hidden');
                setMusicVolume(inQuiz ? LOW_VOLUME : HIGH_VOLUME);
            }
        };

        window.addEventListener('load', async () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') themeBtn.click();
            
            resizeCanvas();
            initParticles();
            animateCanvas();
            window.addEventListener('resize', resizeCanvas);

            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    if (animationFrameId) cancelAnimationFrame(animationFrameId);
                    bgMusic.pause();
                } else {
                    animateCanvas();
                    if (!isUserMuted && audioInitialized) bgMusic.play().catch(() => {});
                }
            });

            try {
                const ts = new Date().getTime();
                const res = await fetch(`./data/subjects.json?v=${ts}`);
                allSubjects = await res.json();
                
                const container = document.getElementById('subject-button-container');
                container.innerHTML = '';
                allSubjects.forEach((sub, i) => {
                    const btn = document.createElement('button');
                    btn.textContent = sub.title;
                    btn.className = 'subject-btn interactive-btn subject-inactive w-full p-4 rounded-lg text-lg reveal-item';
                    btn.style.animationDelay = `${i * 50}ms`;
                    btn.onclick = () => {
                         document.querySelectorAll('.subject-btn').forEach(b => {
                             b.classList.remove('subject-active'); b.classList.add('subject-inactive');
                         });
                         btn.classList.remove('subject-inactive'); btn.classList.add('subject-active');
                         
                         const start = document.getElementById('start-btn');
                         start.classList.remove('hidden', 'reveal-item'); 
                         void start.offsetWidth; 
                         start.classList.add('reveal-item');
                         start.onclick = () => startQuiz(sub.id);
                    };
                    container.appendChild(btn);
                });
                
                const savedState = localStorage.getItem(QUIZ_STATE_KEY);
                if (savedState) {
                    const parsed = JSON.parse(savedState);
                    if(parsed && parsed.subjectId && parsed.answers) {
                         menuContainer.classList.remove('screen-visible');
                         menuContainer.classList.add('screen-hidden');
                         quizContainer.classList.remove('screen-hidden');
                         quizContainer.classList.add('screen-visible');
                         startQuiz(parsed.subjectId, parsed);
                    } else {
                         clearQuizState();
                         finishMenuLoad();
                    }
                } else {
                    finishMenuLoad();
                }

            } catch (e) { console.error(e); loadingSpinner.innerHTML = '<p class="text-red-500">Gagal memuat data.</p>'; }
        });

        function finishMenuLoad() {
            loadingSpinner.classList.add('hidden');
            document.getElementById('subject-button-container').classList.remove('hidden');
        }

        document.body.addEventListener('click', initAudio, { once: true });
    </script>
</body>
</html>
